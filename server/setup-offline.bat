@echo off
chcp 65001 >nul
cls
setlocal enabledelayedexpansion

REM ============================================
REM   Termo Thermal Analysis Server
REM   ูุตุจ ุขููุงู ู ุฑุงูโุงูุฏุงุฒ ุฎูุฏฺฉุงุฑ ุณุฑูุฑ
REM ============================================

echo.
echo โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo โ   ๐ Termo Thermal Analysis Server - ูุตุจ ุขููุงู          โ
echo โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo.

cd /d "%~dp0"

REM ============================================
REM ฺฏุงู 1: ุจุฑุฑุณ Python
REM ============================================
echo [1/7] ๐ ุจุฑุฑุณ ูุตุจ Python...
python --version >nul 2>&1
if errorlevel 1 (
    echo โ Python ูุตุจ ูุณุช ุง ุฏุฑ PATH ุชุนุฑู ูุดุฏู!
    echo.
    echo ๐ฅ ูุทูุงู Python 3.8 ุง ุจุงูุงุชุฑ ุฑุง ุงุฒ https://python.org ูุตุจ ฺฉูุฏ
    echo ๐ก ุญุชูุงู ฺฏุฒูู "Add Python to PATH" ุฑุง ูุนุงู ฺฉูุฏ
    echo.
    pause
    exit /b 1
)

for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
echo โ Python %PYTHON_VERSION% ุงูุช ุดุฏ
echo.

REM ============================================
REM ฺฏุงู 2: ุงุฌุงุฏ ูุญุท ูุฌุงุฒ
REM ============================================
echo [2/7] ๐ฆ ุงุฌุงุฏ ูุญุท ูุฌุงุฒ Python...
if not exist "venv" (
    echo โณ ุฏุฑ ุญุงู ุงุฌุงุฏ ูุญุท ูุฌุงุฒ...
    python -m venv venv
    if errorlevel 1 (
        echo โ ุฎุทุง ุฏุฑ ุงุฌุงุฏ ูุญุท ูุฌุงุฒ!
        pause
        exit /b 1
    )
    echo โ ูุญุท ูุฌุงุฒ ุจุง ููููุช ุงุฌุงุฏ ุดุฏ
) else (
    echo โ ูุญุท ูุฌุงุฒ ุงุฒ ูุจู ููุฌูุฏ ุงุณุช
)
echo.

REM ============================================
REM ฺฏุงู 3: ูุนุงูโุณุงุฒ ูุญุท ูุฌุงุฒ
REM ============================================
echo [3/7] ๐ ูุนุงูโุณุงุฒ ูุญุท ูุฌุงุฒ...
call venv\Scripts\activate.bat
if errorlevel 1 (
    echo โ ุฎุทุง ุฏุฑ ูุนุงูโุณุงุฒ ูุญุท ูุฌุงุฒ!
    pause
    exit /b 1
)
echo โ ูุญุท ูุฌุงุฒ ูุนุงู ุดุฏ
echo.

REM ============================================
REM ฺฏุงู 4: ูุตุจ ูุงุจุณุชฺฏโูุง (ุขููุงู/ุขููุงู)
REM ============================================
echo [4/7] ๐ ูุตุจ ูุงุจุณุชฺฏโูุง Python...
echo.

REM ุจุฑุฑุณ ูุฌูุฏ ูพูุดู wheelhouse
if exist "wheelhouse" (
    echo ๐พ ูพูุดู wheelhouse ุงูุช ุดุฏ - ูุตุจ ุขููุงู
    echo โณ ุฏุฑ ุญุงู ูุตุจ ุงุฒ ูุงูโูุง ูุญู...
    
    REM ุจูโุฑูุฒุฑุณุงู pip (ุขููุงู)
    python -m pip install --upgrade pip --no-index --find-links=wheelhouse 2>nul
    
    REM ูุตุจ ูุงุจุณุชฺฏโูุง (ุขููุงู)
    pip install --no-index --find-links=wheelhouse -r requirements.txt
    
    if errorlevel 1 (
        echo โ๏ธ  ุจุฑุฎ ูพฺฉุฌโูุง ุงุฒ wheelhouse ูุตุจ ูุดุฏูุฏ
        echo ๐ ุชูุงุด ุจุฑุง ูุตุจ ุงุฒ ุงูุชุฑูุช...
        pip install -r requirements.txt
        if errorlevel 1 (
            echo โ ุฎุทุง ุฏุฑ ูุตุจ ูุงุจุณุชฺฏโูุง!
            echo.
            echo ๐ก ุฑุงูโุญูโูุง ูพุดููุงุฏ:
            echo    1. ุงุชุตุงู ุงูุชุฑูุช ุฑุง ุจุฑุฑุณ ฺฉูุฏ
            echo    2. ุฏุณุชูุฑ ุฒุฑ ุฑุง ุจู ุตูุฑุช ุฏุณุช ุงุฌุฑุง ฺฉูุฏ:
            echo       pip install -r requirements.txt
            echo.
            pause
            exit /b 1
        )
    ) else (
        echo โ ููู ูุงุจุณุชฺฏโูุง ุจุง ููููุช ุงุฒ wheelhouse ูุตุจ ุดุฏูุฏ
    )
) else (
    echo โ๏ธ  ูพูุดู wheelhouse ุงูุช ูุดุฏ
    echo ๐ ูุตุจ ุงุฒ ุงูุชุฑูุช...
    
    REM ุจูโุฑูุฒุฑุณุงู pip
    python -m pip install --upgrade pip
    
    REM ูุตุจ ูุงุจุณุชฺฏโูุง
    pip install -r requirements.txt
    
    if errorlevel 1 (
        echo โ ุฎุทุง ุฏุฑ ูุตุจ ูุงุจุณุชฺฏโูุง!
        echo.
        echo ๐ก ุจุฑุง ุงุฌุงุฏ ูุตุจ ุขููุงู:
        echo    1. ุฑู ุณุณุชู ุจุง ุงูุชุฑูุช ุฏุณุชูุฑ ุฒุฑ ุฑุง ุงุฌุฑุง ฺฉูุฏ:
        echo       mkdir wheelhouse
        echo       pip download -r requirements.txt -d wheelhouse
        echo    2. ูพูุดู wheelhouse ุฑุง ฺฉูพ ฺฉูุฏ
        echo.
        pause
        exit /b 1
    )
    echo โ ูุงุจุณุชฺฏโูุง ุจุง ููููุช ูุตุจ ุดุฏูุฏ
)
echo.

REM ============================================
REM ฺฏุงู 5: ุงุฌุงุฏ ูพูุดูโูุง ููุฑุฏ ูุงุฒ
REM ============================================
echo [5/7] ๐ ุงุฌุงุฏ ูพูุดูโูุง ููุฑุฏ ูุงุฒ...
if not exist "temp_uploads" mkdir temp_uploads >nul 2>&1
if not exist "extracted_images" mkdir extracted_images >nul 2>&1
if not exist "projects" mkdir projects >nul 2>&1
if not exist "data" mkdir data >nul 2>&1
if not exist "..\projects" mkdir "..\projects" >nul 2>&1
echo โ ูพูุดูโูุง ุขูุงุฏู ุดุฏูุฏ
echo.

REM ============================================
REM ฺฏุงู 6: ุจุฑุฑุณ ุฏุชุงุจุณ
REM ============================================
echo [6/7] ๐พ ุจุฑุฑุณ ุฏุชุงุจุณ...
if not exist "app\db\termo.db" (
    echo ๐จ ุฏุฑ ุญุงู ุงุฌุงุฏ ุฏุชุงุจุณ...
    REM ุฏุชุงุจุณ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุฑ ุงููู ุงุฌุฑุง ุณุงุฎุชู ูโุดูุฏ
    echo โ ุฏุชุงุจุณ ุฏุฑ ุงููู ุงุฌุฑุง ุงุฌุงุฏ ุฎูุงูุฏ ุดุฏ
) else (
    echo โ ุฏุชุงุจุณ ููุฌูุฏ ุงุณุช
)
echo.

REM ============================================
REM ฺฏุงู 7: ุงุฌุฑุง ุณุฑูุฑ
REM ============================================
echo [7/7] ๐ ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ...
echo.
echo โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo โ  โจ ุณุฑูุฑ ุจุง ููููุช ุฑุงูโุงูุฏุงุฒ ุดุฏ!                         โ
echo โ                                                            โ
echo โ  ๐ ุขุฏุฑุณ ุณุฑูุฑ:                                            โ
echo โ     http://127.0.0.1:8000                                 โ
echo โ     http://localhost:8000                                 โ
echo โ                                                            โ
echo โ  ๐ ูุณุชูุฏุงุช API:                                          โ
echo โ     http://127.0.0.1:8000/docs                            โ
echo โ     http://127.0.0.1:8000/redoc                           โ
echo โ                                                            โ
echo โ  ๐ ุจุฑุง ุชููู ุณุฑูุฑ: Ctrl+C                               โ
echo โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo.
echo โณ ุณุฑูุฑ ุฏุฑ ุญุงู ุจุงุฑฺฏุฐุงุฑ...
echo.

REM ุงุฌุฑุง ุณุฑูุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ run.py
python run.py

REM ุงฺฏุฑ ุณุฑูุฑ ูุชููู ุดุฏ
echo.
echo โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo ุณุฑูุฑ ูุชููู ุดุฏ
echo โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo.

pause
